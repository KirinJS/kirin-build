"use strict";
var _ = require("underscore");
var Generator = require("./generators").Generator;

var defaultIndent = "    ";

exports.ModuleGenerator = (function () {
    function CommonJs (usage) {
        this.usage = usage;
        this.indent = 0;
    }
    CommonJs.prototype = new Generator();
    
    var builtins = {
            "object": "JSONObject",
            "array": "JSONArray",
            "int": "int",
            "float": "float",
            "double": "double",
            "short": "short",
            "boolean": "boolean",
            "string": "String"
    };
    
    var builtinImportables = {
            "object": "org.json.JSONObject",
            "array": "org.json.JSONArray"
    };
    
    CommonJs.prototype.importLines = function (importsArray) {
       return [];
    };

    CommonJs.prototype.packageLines = function (classObject) {
        // NOP;
       return [];
    };
    
    function typeString (type) {
        var builtin = builtins[type];
        
        return builtin ? builtin : type.name;
    }
    
    function docsLines(docs, params, suppressIndent) {
        if (_.isUndefined(suppressIndent) && _.isBoolean(params)) {
            suppressIndent = params;
            params = null;
        }
        suppressIndent = true;
        var indent = suppressIndent ? "" : defaultIndent;
        
        var lines = [],
            comment = false;
        
        if (docs) {
            comment = true;
            lines.push(indent + "/**");
            lines.push(indent + " * " + docs);
        }

        if (params) {
            _.each(params, function (param) {
                if (!comment) {
                    lines.push(indent + "/**");
                    comment = true;
                }
                
                var paramLine = [" * @param", param.name, "{@link " + typeString(param.type) + "}"];
                if (param.docs) {
                    paramLine.push(param.docs);
                }
                lines.push(indent + paramLine.join(" "));
            });
        }
        
        if (comment) {
            lines.push(indent + " */");
        }
        
        return lines;
    }
    
    
    CommonJs.prototype.interfaceDeclLines = function (classObject) {
        return [];
    };    
    
    CommonJs.prototype.propertyLines = function (properties) {
        var self = this;
        var lines = [];
        
        var prefix = null;
        _.each(properties, function (p) {
            var typeName = typeString(p.type),
                paramName = p.name;
            var line;
            if (prefix) {
                line = prefix;
            } else {
                line = "var " + paramName;
                prefix = defaultIndent + paramName;
            }
            lines.push(line + ";");
        });
        
        return _.flatten(lines);
    };
    
    CommonJs.prototype.methodLine = function (sig) {
        var lines = [];
        
        var comment = false;

        lines.push(docsLines(sig.docs, sig.params));
        
        var namedArgs = _.filter(sig.name.split(":"), function (t) {
            return t;
        });
        
        var isFirst = true;
        var methodName = _.map(namedArgs, function (s) {
            if (isFirst) {
                isFirst = false;
                return s;
            }
            return s[0].toUpperCase() + s.substring(1);
        }).join("");
        
        var params  = _.map(sig.params, function (p) {
            return p.name;
        });        
        lines.push("exports." + methodName + " = function (" + params.join(", ") + ") {");
        lines.push(defaultIndent + "// AUTOGENERATED, COPY DON'T EDIT");
        lines.push("};")
        
        return _.flatten(lines);
    };
    
    CommonJs.prototype.methodLines = function (sigArray) {
        var self = this;
        var allLines = [
            "exports.onLoad = function (nativeObject) {};",  " ",
            "exports.onResume = function () {};", " ",
            "exports.onPause = function () {};", " ",
            "exports.onUnload = function () {};", " "
                        ];
         _.each(sigArray, function (sig) {
            var line = self.methodLine(sig);
            allLines.push(line);
            allLines.push(" ");
            
        });
        return allLines;
    };
    
    
    CommonJs.prototype.footer = function () {
        return "";
    };
    
    return CommonJs;
}());

exports.getOutputDirectory = function (nodeModule, kirinInfo, platformBlock) {
    return nodeModule.directory + "/stubs";
};

exports.generateFiles = function (filePrefix, classOrder, fileMap, nodeModule) {
    fileMap = fileMap || {};
    var generator = new exports.ModuleGenerator(),
        path = require("path");
    
    if (!filePrefix) {
        throw new Error("An idlOutput is needed in package.json");
    }
    
    _.each(classOrder, function (irClass) {
        if (!irClass) {
            return;
        }
        if (irClass.role === "javascript") {            
            var lines = generator.lines(irClass),
                content = lines.join("\n"),
                filename = irClass.name + ".stub.js";
            
            fileMap[path.join(filePrefix, filename)] = content;
            nodeModule.addFile(path.join(filePrefix, filename));
        }
    });
    
    return fileMap;
};
